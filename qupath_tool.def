Bootstrap: localimage
From: qupath_base.sif

%files
    scripts/prefs.groovy /scripts/prefs.groovy
    scripts/segment.groovy /scripts/segment.groovy
    scripts/models/stardist_model_1_channel.pb /scripts/models/stardist_model_1_channel.pb
    scripts/tumor_classifier.json /scripts/tumor_classifier.json

    extensions /scripts/userdir/extensions

    cli/.python-version /cli/.python-version
    cli/pyproject.toml /cli/pyproject.toml
    cli/uv.lock /cli/uv.lock

    cli/main.py /cli/main.py

%post
    # install needed dependencies
    curl -LsSf https://astral.sh/uv/install.sh | env UV_UNMANAGED_INSTALL="/cli" sh
    chmod +x /cli/uv
    cd /cli
    which python
    /cli/uv export --frozen | /cli/uv pip install --system -r -
    rm /cli/uv /cli/uvx

%runscript
    python /cli/main.py $*

